name: Automatic Testing Upon PR

on:
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    container:
      image: node:22
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use npm cache
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            npm-${{ runner.os }}-

      - name: Install dependencies (ci, no audit)
        run: npm ci --no-audit

      # Optional: run your security gate before tests/build
      - name: Check audit
        run: npx check-audit --fail-on-unresolved

      - name: Lint
        run: npm run lint

      - name: Test
        run: npm test

      - name: Build
        run: npm run build

      # If you emit type declarations, verify they exist
      - name: Verify type declarations
        run: |
          test -f dist/types/index.d.ts || (echo "Missing dist/types/index.d.ts" && exit 1)

      # Optional: generate docs if desired
      - name: Generate docs
        run: npm run doc
